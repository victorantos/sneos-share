import fs from 'fs';
import path from 'path';
import matter from 'gray-matter';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const AUTOGENERATED_DIR = path.join(__dirname, '../docs/autogenerated');

const categoryFolders = {
  'ai-comparison': 'AI Comparison',
  'education': 'Education',
  'finance': 'Finance',
  'lawyers': 'Lawyers',
  'legal': 'Legal',
  'research': 'Research',
  'universities': 'Universities',
  'viral-content': 'Viral Content'
};

Object.entries(categoryFolders).forEach(([folderName, categoryTitle]) => {
  const categoryPath = path.join(AUTOGENERATED_DIR, folderName);
  const readmePath = path.join(categoryPath, 'README.md');

  if (!fs.existsSync(categoryPath)) {
    console.log(`⚠️  Category folder not found: ${folderName}`);
    return;
  }

  // Read all markdown files in this category (excluding README.md)
  const files = fs.readdirSync(categoryPath)
    .filter(f => f.endsWith('.md') && f !== 'README.md')
    .map(filename => {
      const filePath = path.join(categoryPath, filename);
      const content = fs.readFileSync(filePath, 'utf-8');
      const { data } = matter(content);

      return {
        filename: filename.replace('.md', ''),
        title: data.title || filename.replace('.md', ''),
        description: data.description || '',
        date: data.date
      };
    })
    .sort((a, b) => a.title.localeCompare(b.title));

  // Generate README content
  let content = `---
title: ${categoryTitle}
---

# ${categoryTitle} Posts

Browse all ${files.length} AI comparison posts in the ${categoryTitle} category.

## Posts

`;

  files.forEach(post => {
    content += `### [${post.title}](${post.filename}.md)\n\n`;
    if (post.description) {
      content += `${post.description}\n\n`;
    }
  });

  content += `---

*Total posts: ${files.length}*
`;

  // Write README file
  fs.writeFileSync(readmePath, content, 'utf-8');
  console.log(`✅ Generated README for ${categoryTitle} with ${files.length} posts`);
});

console.log('✅ All category README files generated');